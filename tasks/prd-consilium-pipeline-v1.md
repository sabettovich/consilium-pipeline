# PRD: Consilium Pipeline v1 (Оркестрация + Миграция)

Источник правил: `doc/rules/create-prd.md`
Связанные документы: `doc/plan/architecture_resilience_spec.md`, `doc/plan/idea.md`

## Резюме
- **Цель**: эволюция юридического конвейера: надёжная оркестрация (Dramatiq, DLQ, S3→SQS) и миграция данных (S3, Vault, БД) без простоя.
- **MVP фокус**: регистрация документа, S3→SQS ingestion, OCR (Tesseract→ABBYY по порогам), запись результатов в Obsidian Vault (источник истины), статусы и журнал проблем.
- **Ключевые решения**: Broker=Redis, БД=PostgreSQL, Vault=истина, S3=mapping для старых ключей и новые префиксы, cutover с дельта‑синхрой и freeze ≤ 15 минут.

## Проблема / Цели
- **Проблема**: текущий монолит без брокера и DLQ, смешанная логика в скриптах, отсутствие надёжной оркестрации и наблюдаемости, Vault используется вручную.
- **Цели**:
  - Оркестрация: Dramatiq очереди по типу/размеру, ретраи, DLQ, S3→SQS ingestion.
  - Миграция: перенос БД в Postgres, индексация S3, формализация связи с Vault как источником истины.

## Роли / Пользователи
- **Юрист‑оператор**: работает с `.md` в Obsidian Vault, видит статусы/ошибки в UI, подтверждает «принято пользователем».
- **Техоператор**: следит за очередями, DLQ, перезапусками, метриками; настраивает лимиты и ретраи.

## Объём MVP (scope)
- Регистрация документа и метаданных.
- Direct‑to‑S3 (presigned PUT, multipart). События `S3:ObjectCreated:*` → SQS → ingestion‑consumer.
- OCR локальный (Tesseract); fallback → ABBYY при `coverage<70%` или `avg_confidence<0.6`.
- Запись распознанного текста в Vault (артефакты в `artifacts/…`, консолидация отдельным шагом).
- Журнал проблем (Problem Log) + ручной перезапуск.
- Минимальная наблюдаемость: структурные логи + базовые метрики Dramatiq.

## Вне MVP (non‑goals сейчас)
- Полнотекстовый поиск/аналитика.
- Продвинутая AI‑классификация/генерация.
- KMS‑ключи и тонкие IAM‑политики (пока SSE‑S3 и базовые правила).

## Пользовательские истории
- Как юрист, хочу загружать документ и через N минут видеть текст в Vault, чтобы работать с ним.
- Как техоператор, хочу видеть задачу в DLQ с причинами и перезапускать после исправления.
- Как юрист, хочу принять документ, чтобы система очистила промежуточные артефакты и зафиксировала итог.

## Функциональные требования
- **Загрузка**: presigned PUT в S3; API сохраняет метаданные; S3 Events→SQS триггерят ingestion.
- **Маршрутизация**: очереди по типу/размеру (малые — абсолютный приоритет).
- **OCR**: локально; fallback во внешний сервис при низком качестве.
- **Хранилища**: Vault — источник истины для текста; БД хранит индексы/ссылки; S3 — бинарные объекты.
- **Журнал проблем**: запись «твёрдых» и «временных» ошибок; ручной перезапуск после утверждения.
- **Принятие пользователем**: `POST /documents/{id}/accept`, очистка промежуточных артефактов.

## Нефункциональные требования
- **Надёжность**: идемпотентность (ключ `sha256+size+type+tenant`), ретраи с backoff, DLQ.
- **Производительность**: приоритет малых задач; троттлинг внешних API.
- **Наблюдаемость**: структурные логи, базовые метрики воркеров.
- **Безопасность**: SSE‑S3, Block Public Access, presigned TTL 10 минут (упрощённо для старта).
- **Деплой**: Docker Compose локально; systemd в проде; простой запуск для новичков.

## Данные и схема (PostgreSQL)
- `tenant (tenant_id)`; стартово `default`.
- `case (id, tenant_id, case_id, …)` — соответствует `matter_id`.
- `document (id, tenant_id, case_id, doc_kind, title, mime, size, sha256, storage_ref, vault_path_main, idempotency_key, status, created_at, updated_at)`.
- `artifact (id, tenant_id, document_id, kind, vault_path, sha256, size, metrics, created_at, updated_at)`.
- `storage_object (id, tenant_id, bucket, key, etag, size, document_id?, case_id?, created_at, updated_at)`.
- `job`, `task` — статусы обработки и попыток.
- `problem_log` — ошибки/решения/утверждения.
- `event` — события аудита (`DocumentIngested`, `DocumentAccepted`, …).

## Интеграции
- **S3**: события → SQS; старые объекты — mapping в `storage_object`, новые — по префиксам `tenant/{tenant}/case/{case}/…`.
- **Vault**: индексатор Vault↔БД (рекурсивный скан, sha256/mtime/size), артефакты в `artifacts/…`, `main.md` редактируется человеком/оркестратором.
- **OCR/ABBYY**: через адаптеры с троттлингом и ретраями.

## Архитектура
- **Broker**: Redis (Dramatiq broker + кэш идемпотентности).
- **Очереди**: `ocr_pdf_small|…`, `ocr_img_small|…`, `parse_doc_*`, `asr_audio_*` (на будущее), `gen_doc_*` — малые в приоритете.
- **События**: `S3:ObjectCreated:*` → `SQS` → `ingestion-consumer` → постановка задач.

## Принятие/критерии успеха (MVP)
- **KPI‑1**: ≥95% загруженных документов попадают в очередь и доходят до публикации текста в Vault.
- **KPI‑2**: DLQ доступен в API, задачи из DLQ перезапускаются руками, журнал проблем хранит 10 дней.
- **KPI‑3**: Отчёт целостности Vault↔БД↔S3 без критических расхождений.
- **KPI‑4**: Базовые метрики очередей/ошибок доступны (Prometheus middleware Dramatiq или эквивалент).

## Этапы / Вехи
- **M1. Схема БД и миграции**: модели SQLAlchemy + Alembic; подключение Postgres.
- **M2. Broker и базовые очереди**: Redis + Dramatiq; акторы для OCR; ретраи; DLQ на уровне брокера.
- **M3. S3→SQS ingestion**: включить события; консюмер; идемпотентная регистрация.
- **M4. Vault индексатор**: скан, mapping, запись артефактов/ссылок; базовые отчёты целостности.
- **M5. Problem Log + перезапуски**: таблица, API‑эндпоинты, UI черновой.
- **M6. Cutover**: дельта‑синхра, freeze ≤ 15 мин, smoke‑тесты, переключение.

## Риски и смягчение
- **Живой бакет S3**: не копировать/не переименовывать; использовать mapping; HEAD‑проверки.
- **Конфликты Vault**: воркеры пишут в `artifacts/`; консолидация отдельно; журнал расхождений.
- **Производительность OCR**: приоритет малых; fallback в ABBYY при низком качестве; троттлинг.
- **Сложность миграции БД**: dry‑run ETL, отчёты, идемпотентные upsert.

## План cutover (коротко)
1) Полная ETL‑миграция на фоне. 2) Включить дельта‑синхронизатор. 3) Freeze записи ≤ 15 мин. 4) Финальная дельта + проверки. 5) Переключение API. 6) План отката: вернуть запись на старую систему при сбое smoke‑тестов.

## Отслеживание прогресса
- Чек‑листы по вехам (M1..M6) в этом PRD.
- TODO‑задачи ведутся инструментом в `consilium.dramatiq` (параллельно обновляю статусы).

